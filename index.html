<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyJail Terminal with Flag</title>

    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css">
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <style>
        :root {
            --bg-color: #282828;
            --fg-color: #ebdbb2;
            --accent-color: #fe8019;
            --highlight-color: #8ec07c;
            --border-color: #3c3836;
        }

        body {
            font-family: monospace;
            background-color: var(--bg-color);
            color: var(--fg-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: var(--accent-color);
        }

        #terminal {
            width: 90%;
            height: 300px;
            background-color: #1d2021;
            color: var(--fg-color);
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 14px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        #command {
            width: 80%;
            background-color: #282828;
            color: var(--fg-color);
            border: 1px solid var(--border-color);
            padding: 8px;
            font-size: 16px;
        }

        button {
            padding: 8px;
            margin-left: 10px;
            background-color: var(--accent-color);
            color: black;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: var(--highlight-color);
        }
    </style>
</head>
<body>

    <h1>PyJail Terminal</h1>
    <div id="terminal">Welcome to the PyJail Terminal! Type your Python commands below.</div>
    
    <div style="display: flex;">
        <input type="text" id="command" placeholder="Enter Python command">
        <button id="runButton">Run</button>
    </div>

    <py-script>
        import base64
        import codecs
        from io import StringIO
        from js import document
        from pyodide.ffi import create_proxy

        # Simulated File System (Fake Linux root dir structure)
        fake_file_system = {
            "/flag.txt": "flag{qu1nn_w@s_h3re}",
            "/home": ["user1", "user2"],
            "/usr": ["bin", "lib", "local"],
            "/etc": ["passwd", "shadow"],
            "/tmp": [],
        }

        # Simulate Unix commands like 'ls', 'uname', 'cat', etc.
        def mock_os_listdir(path):
            if path == "/":
                return list(fake_file_system.keys())  # Simulate the root directory
            elif path in fake_file_system:
                return fake_file_system[path]  # Return the contents of the folder
            else:
                return []  # If the directory doesn't exist, return an empty list

        def mock_os_popen(command):
            # Simulate output for various Unix commands
            command = command.strip()

            if command.startswith("cat "):
                file_path = command[4:]
                return StringIO(fake_file_system.get(file_path, "File not found."))

            elif command == "uname":
                return StringIO("FakeLinuxOS")

            elif command.startswith("ls"):
                path = command[3:].strip() if len(command) > 3 else "/"
                return StringIO("\n".join(mock_os_listdir(path)))

            elif command == "pwd":
                return StringIO("/home/user1")  # Simulating the current directory

            elif command.startswith("echo"):
                return StringIO(command[5:].strip())  # Just return the string after 'echo'

            return StringIO("Unknown command")

        def mock_os_path_exists(path):
            # Simulate file existence check
            return path in fake_file_system

        # Fake os module to mock os functionality
        class FakeOS:
            def listdir(self, path):
                return mock_os_listdir(path)

            def popen(self, command):
                return mock_os_popen(command)

            def path(self):
                return mock_os_path_exists

        # Instantiate fake os module
        os = FakeOS()

        # Encrypted flag (Base64 and ROT13 encoded flag)
        encrypted_flag = "MzkuM3gkqGShoy93DUAsnQAlMK0="  # ROT13 and Base64 encoded flag

        # Mock the decryption of the flag
        def decrypt_flag():
            decoded_rot13 = base64.b64decode(encrypted_flag).decode('utf-8')  # Now this is a string
            decoded_flag = codecs.decode(decoded_rot13, 'rot_13')  # Reverse ROT13
            return decoded_flag

        # Override print to send output to the terminal
        def custom_print(*args, **kwargs):
            output = " ".join(map(str, args))
            terminal.innerHTML += f"\n{output}"

        # Replace print with custom_print
        print = custom_print

        terminal = document.getElementById("terminal")
        command_input = document.getElementById("command")

        def safe_exec(code):
            try:
                restricted_locals = {"os": os, "print": print}
                exec(code, restricted_locals)
                return ""  # Just return an empty string to avoid "Code executed safely."
            except Exception as e:
                return f"Error: {e}"

        def execute_command(event=None):
            command = command_input.value.strip()
            if command:
                terminal.innerHTML += f"\n>>> {command}"

                # Check if the command requires displaying results in the terminal
                if "cat /flag.txt" in command:
                    result = fake_file_system["/flag.txt"]
                else:
                    result = safe_exec(command)  # Safe execution for other commands

                # Ensure that the result is properly displayed
                if isinstance(result, str):
                    terminal.innerHTML += f"\n{result}"  # Display directly if it's a string
                else:
                    terminal.innerHTML += f"\n{result.read()}"  # If it's a file-like object, use read()

                command_input.value = ""  # Clear the input field after execution
                terminal.scrollTop = terminal.scrollHeight  # Scroll to the latest output

        execute_command_proxy = create_proxy(execute_command)
        command_input_proxy = create_proxy(lambda event: execute_command_proxy(event) if event.key == "Enter" else None)

        document.getElementById("runButton").addEventListener("click", execute_command_proxy)
        command_input.addEventListener("keydown", command_input_proxy)
    </py-script>

</body>
</html>
